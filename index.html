<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Appel Hardest Levels List</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-950 text-gray-100 font-sans">
  <div class="max-w-7xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">Appel Hardest Levels List</h1>

    <!-- Search + sort -->
    <div class="flex flex-wrap gap-4 mb-6">
      <input type="text" id="search" placeholder="Search levels..."
        class="p-2 rounded bg-gray-800 border border-gray-700 text-sm w-64">
      <select id="sort" class="p-2 rounded bg-gray-800 border border-gray-700 text-sm">
        <option value="Rank">Sort by Rank</option>
        <option value="Level">Sort by Level</option>
        <option value="Creator(s)">Sort by Creator</option>
        <option value="Difficulty">Sort by Difficulty</option>
      </select>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto rounded-lg shadow">
      <table class="min-w-full border-collapse">
        <thead class="bg-gray-800">
          <tr>
            <th class="px-3 py-2 text-left text-sm font-semibold">Rank</th>
            <th class="px-3 py-2 text-left text-sm font-semibold">Level</th>
            <th class="px-3 py-2 text-left text-sm font-semibold">Creator(s)</th>
            <th class="px-3 py-2 text-left text-sm font-semibold">Difficulty</th>
            <th class="px-3 py-2 text-left text-sm font-semibold">Video</th>
          </tr>
        </thead>
        <tbody id="levelTable" class="divide-y divide-gray-700"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
    <div class="bg-gray-900 rounded-2xl shadow-xl max-w-lg w-full p-6 relative">
      <button id="closeModal" class="absolute top-3 right-3 text-gray-400 hover:text-gray-200">&times;</button>
      <h2 id="modalTitle" class="text-xl font-bold mb-4"></h2>
      <p><span class="font-semibold">Verifier:</span> <span id="modalVerifier"></span></p>
      <p><span class="font-semibold">CWR:</span> <span id="modalCWR"></span></p>
      <p><span class="font-semibold">Notes:</span></p>
      <p id="modalNotes" class="text-gray-300 mt-2"></p>
    </div>
  </div>

  <script>
    const SHEET_ID = "1q01STuHSABJcptgHRmfFeXzkhFRtY6ymurO9uxkflfQ"; 
    const SHEET_NAME = "AHHL:E"; 
    const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tqx=out:json`;

    let levels = [];
    const table = document.getElementById("levelTable");
    const searchInput = document.getElementById("search");
    const sortSelect = document.getElementById("sort");

    // Modal elements
    const modal = document.getElementById("modal");
    const closeModal = document.getElementById("closeModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalVerifier = document.getElementById("modalVerifier");
    const modalCWR = document.getElementById("modalCWR");
    const modalNotes = document.getElementById("modalNotes");

    closeModal.addEventListener("click", () => modal.classList.add("hidden"));
    modal.addEventListener("click", (e) => {
      if (e.target === modal) modal.classList.add("hidden");
    });

    async function fetchLevels() {
      try {
        const res = await fetch(URL);
        const text = await res.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));

        const cols = json.table.cols.map(c => c.label);
        return json.table.rows.map(row => {
          let obj = {};
          row.c.forEach((cell, i) => {
            obj[cols[i]] = cell ? cell.v : "";
          });
          return obj;
        });
      } catch (err) {
        console.error("Failed to fetch sheet:", err);
        return [];
      }
    }

    function renderTable(data) {
      table.innerHTML = "";
      data.forEach(lvl => {
        const row = document.createElement("tr");
        row.className = "hover:bg-gray-800 cursor-pointer";
        row.innerHTML = `
          <td class="px-3 py-2">${lvl.Rank || ""}</td>
          <td class="px-3 py-2 font-medium">${lvl.Level || ""}</td>
          <td class="px-3 py-2">${lvl["Creator(s)"] || ""}</td>
          <td class="px-3 py-2">${lvl.Difficulty || ""}</td>
          <td class="px-3 py-2">
            ${lvl.Video && lvl.Video.trim() !== "-" 
              ? `<a href="${lvl.Video}" target="_blank" class="text-blue-400 underline">Watch</a>` 
              : ""}
          </td>
        `;
        row.addEventListener("click", () => {
          modalTitle.textContent = lvl.Level || "Unknown Level";
          modalVerifier.textContent = lvl["Verifier/First Victor"] || "N/A";
          modalCWR.textContent = lvl["CWR (mostly from sr.c)"] || "N/A";
          modalNotes.textContent = lvl.Notes || "N/A";
          modal.classList.remove("hidden");
        });
        table.appendChild(row);
      });
    }

    function filterAndSort() {
      const query = searchInput.value.toLowerCase();
      let filtered = levels.filter(lvl =>
        (lvl.Level || "").toLowerCase().includes(query) ||
        (lvl["Creator(s)"] || "").toLowerCase().includes(query)
      );
      const sortKey = sortSelect.value;
      filtered.sort((a, b) =>
        (a[sortKey] || "").toString().localeCompare((b[sortKey] || "").toString(), undefined, {numeric:true})
      );
      renderTable(filtered);
    }

    searchInput.addEventListener("input", filterAndSort);
    sortSelect.addEventListener("change", filterAndSort);

    (async () => {
      levels = await fetchLevels();
      filterAndSort();
    })();
  </script>
</body>
</html>